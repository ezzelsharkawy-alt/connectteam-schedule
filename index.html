<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Schedule</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
      color: #fff;
      padding: 24px;
    }
    @keyframes fadein {
      from { opacity:0; transform:translateY(12px); }
      to   { opacity:1; transform:translateY(0); }
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .glass {
      background: linear-gradient(145deg, rgba(255,255,255,.13), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 8px 32px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.15);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
    }
    #app { max-width: 1100px; margin: 0 auto; animation: fadein .4s ease forwards; }
    header {
      padding: 24px 28px 20px;
      border-bottom: 1px solid rgba(255,255,255,.1);
      display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 12px;
    }
    header .left .eyebrow {
      font-size: 11px; font-weight: 700; color: rgba(255,255,255,.4);
      letter-spacing: .12em; text-transform: uppercase; margin-bottom: 4px;
    }
    header .left h1 { font-size: 26px; font-weight: 800; letter-spacing: -.5px; }
    header .left .sub { font-size: 12px; color: rgba(255,255,255,.45); margin-top: 4px; }
    header .right { display: flex; gap: 8px; align-items: center; margin-top: 4px; }
    .btn {
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.15);
      color: rgba(255,255,255,.85);
      border-radius: 12px; padding: 8px 16px;
      cursor: pointer; font-size: 13px; font-weight: 600;
      transition: background .2s;
    }
    .btn:hover { background: rgba(255,255,255,.2); }
    .btn-orange {
      background: linear-gradient(135deg, #F96C35, #e8420a);
      border: none; color: #fff;
      box-shadow: 0 4px 16px rgba(249,108,53,.4);
    }
    .btn-orange:hover { background: linear-gradient(135deg, #ff7d49, #F96C35); }
    #legend {
      padding: 10px 28px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .legend-pill {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 99px; padding: 4px 12px;
      font-size: 11px; font-weight: 700; color: rgba(255,255,255,.8);
    }
    .legend-dot {
      width: 7px; height: 7px; border-radius: 50%; display: inline-block;
    }
    #calendar {
      padding: 12px 20px 28px;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .col-header {
      text-align: center; font-size: 11px; font-weight: 700;
      color: rgba(255,255,255,.4); letter-spacing: .08em;
      text-transform: uppercase; padding: 8px 4px;
    }
    .week-label {
      grid-column: 1 / -1;
      padding: 14px 0 6px;
      display: flex; align-items: center; gap: 12px;
    }
    .week-label span { font-size: 11px; font-weight: 700; color: rgba(255,255,255,.35); letter-spacing: .08em; text-transform: uppercase; }
    .week-label small { font-size: 11px; color: rgba(255,255,255,.25); }
    .week-label hr { flex: 1; border: none; border-top: 1px solid rgba(255,255,255,.07); }
    .day-tile {
      border-radius: 14px; padding: 10px; position: relative;
      overflow: hidden; min-height: 70px;
      transition: transform .2s cubic-bezier(.22,1,.36,1), box-shadow .2s;
      cursor: default;
    }
    .day-tile:hover { transform: translateY(-2px); }
    .day-tile.empty {
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.05);
    }
    .day-tile.has-shifts {
      background: linear-gradient(145deg, rgba(255,255,255,.11), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 2px 12px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.1);
    }
    .day-tile.today {
      background: linear-gradient(145deg, rgba(249,108,53,.3), rgba(249,108,53,.1));
      border: 1px solid rgba(249,108,53,.45);
      box-shadow: 0 4px 20px rgba(249,108,53,.2);
    }
    .today-badge {
      position: absolute; top: 6px; right: 6px;
      background: #F96C35; color: #fff;
      font-size: 7.5px; font-weight: 900;
      padding: 2px 6px; border-radius: 99px; letter-spacing: .06em;
    }
    .day-num {
      font-size: 15px; font-weight: 800; line-height: 1; margin-bottom: 0;
    }
    .day-num.empty-num { color: rgba(255,255,255,.2); }
    .day-num.today-num { color: #F96C35; margin-bottom: 8px; }
    .day-num.shift-num { color: rgba(255,255,255,.85); margin-bottom: 8px; }
    .shift-pill {
      display: flex; align-items: flex-start; gap: 6px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 8px; padding: 6px 8px; margin-bottom: 4px;
      transition: transform .15s;
    }
    .shift-pill:hover { transform: translateX(2px); }
    .shift-bar { width: 2.5px; min-height: 28px; border-radius: 99px; flex-shrink: 0; margin-top: 1px; }
    .shift-sched { font-size: 9px; font-weight: 800; letter-spacing: .06em; text-transform: uppercase; margin-bottom: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .shift-label { font-size: 11px; font-weight: 600; color: rgba(255,255,255,.9); line-height: 1.3; }
    .shift-time { font-size: 10px; color: rgba(255,255,255,.45); margin-top: 1px; white-space: nowrap; }
    footer {
      padding: 10px 28px;
      border-top: 1px solid rgba(255,255,255,.08);
      font-size: 11px; color: rgba(255,255,255,.25);
      display: flex; justify-content: space-between;
    }
    #loading {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 80px 20px; text-align: center;
    }
    .spinner {
      width: 36px; height: 36px; border: 3px solid rgba(255,255,255,.1);
      border-top-color: #F96C35; border-radius: 50%;
      animation: spin .8s linear infinite; margin-bottom: 20px;
    }
    #loading h2 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    #loading p { font-size: 13px; color: rgba(255,255,255,.4); }
    #error {
      display: none; flex-direction: column; align-items: center;
      justify-content: center; padding: 80px 20px; text-align: center;
    }
    #error .emoji { font-size: 48px; margin-bottom: 16px; }
    #error h2 { font-size: 18px; font-weight: 700; margin-bottom: 8px; color: rgba(255,255,255,.8); }
    #error p { font-size: 13px; color: rgba(255,255,255,.4); max-width: 380px; line-height: 1.6; }
    #error .steps { margin-top: 20px; text-align: left; background: rgba(255,255,255,.06); border-radius: 12px; padding: 16px 20px; max-width: 380px; }
    #error .steps li { font-size: 13px; color: rgba(255,255,255,.6); margin-bottom: 8px; line-height: 1.5; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.2); border-radius: 99px; }
  </style>
</head>
<body>
<div id="app" class="glass">
  <div id="loading">
    <div class="spinner"></div>
    <h2>Fetching your scheduleâ€¦</h2>
    <p>Checking all 7 calendars, hang tight</p>
  </div>
  <div id="error">
    <div class="emoji">ðŸ”’</div>
    <h2>Not logged in to Connecteam</h2>
    <p>This tool reads your Connecteam session directly. To use it you need to be logged in first.</p>
    <ol class="steps">
      <li>Open <a href="https://app.connecteam.com" target="_blank" style="color:#F96C35">app.connecteam.com</a> in another tab and log in</li>
      <li>Come back to this tab</li>
      <li>Click the button below</li>
    </ol>
    <button class="btn btn-orange" style="margin-top:20px" onclick="init()">ðŸ”„ Try again</button>
  </div>
  <div id="main" style="display:none;flex-direction:column">
    <header>
      <div class="left">
        <div class="eyebrow">My Schedule</div>
        <h1 id="user-name">Loadingâ€¦</h1>
        <div class="sub" id="sub-text"></div>
      </div>
      <div class="right">
        <button class="btn" onclick="refresh()">ðŸ”„ Refresh</button>
      </div>
    </header>
    <div id="legend"></div>
    <div id="calendar"></div>
    <footer>
      <span>âš¡ Fetched via Connecteam API</span>
      <span id="updated-at"></span>
    </footer>
  </div>
</div>

<script>
const SCHEDULES = [
  { name: 'OAR SN101',         color: '#8B5CF6', objectId: '15782348', courseId: '13363740' },
  { name: 'SN5/S4-T',          color: '#9CA3AF', objectId: '14461566', courseId: '12300080' },
  { name: 'OAR SN6',           color: '#F97316', objectId: '8135671',  courseId: '6913463'  },
  { name: 'OAR SN9',           color: '#3B82F6', objectId: '9263640',  courseId: '7861773'  },
  { name: 'SN8 Dubai',         color: '#EAB308', objectId: '7411131',  courseId: '6296158'  },
  { name: 'SN7 Japan',         color: '#EF4444', objectId: '6664952',  courseId: '5649776'  },
  { name: 'GCS VSIL Training', color: '#22C55E', objectId: '7412145',  courseId: '6297032'  },
];
const WEEKS = 3, TZ = 'America/Los_Angeles';

function getCookie(n) {
  const m = document.cookie.match(new RegExp('(?:^|; )' + n + '=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : null;
}

function getWeekRanges() {
  const DAY = 86400000, now = new Date(), dow = now.getUTCDay();
  const satMs = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - (dow === 6 ? 0 : dow + 1)) + 8 * 3600000;
  return Array.from({ length: WEEKS }, (_, i) => {
    const start = new Date(satMs + i * 7 * DAY), end = new Date(satMs + (i + 1) * 7 * DAY - 1);
    return { startDate: start.toISOString(), endDate: end.toISOString() };
  });
}

async function fetchJobMap(s) {
  try {
    const r = await fetch(`https://app.connecteam.com/api/UserDashboard/ShiftScheduler/Data/?objectId=${s.objectId}&courseId=${s.courseId}`, { credentials: 'include' });
    const d = await r.json(), map = {};
    (d?.data?.scheduler_user_data?.jobs || []).forEach(j => { map[j.id] = j.title; });
    return map;
  } catch { return {}; }
}

async function fetchShifts(sched, week, spirit) {
  try {
    const r = await fetch('https://app.connecteam.com/api/UserDashboard/ShiftScheduler/Shifts/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-cache' },
      credentials: 'include',
      body: JSON.stringify({ objectId: sched.objectId, courseId: sched.courseId, startDate: week.startDate, endDate: week.endDate, timezone: TZ, _spirit: spirit }),
    });
    return (await r.json())?.data?.shifts || [];
  } catch { return []; }
}

function formatShift(shift, jobMap, schedName, schedColor, userId) {
  if (!shift.assignedUserIds?.includes(userId)) return null;
  const start = new Date(shift.startTime * 1000), end = new Date(shift.endTime * 1000);
  const timeStr = shift.allDay ? 'All day'
    : `${start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })} â€“ ${end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
  const label = [(jobMap?.[shift.jobId] || ''), (shift.title || '').trim()].filter(Boolean).join(' Â· ') || 'Shift';
  return {
    timeStr, label, schedName, schedColor, sortKey: shift.startTime,
    dayKey: start.toISOString().slice(0, 10),
    dayNum: start.getUTCDate(),
  };
}

function render(myName, allShifts) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'none';
  const main = document.getElementById('main');
  main.style.display = 'flex';

  document.getElementById('user-name').textContent = myName;
  document.getElementById('sub-text').textContent = `${allShifts.length} shift${allShifts.length !== 1 ? 's' : ''} Â· Next ${WEEKS} weeks`;
  document.getElementById('updated-at').textContent = `Updated ${new Date().toLocaleTimeString()}`;

  // Legend
  const activeScheds = [...new Map(allShifts.map(s => [s.schedName, s])).values()];
  document.getElementById('legend').innerHTML = activeScheds.map(s => `
    <div class="legend-pill">
      <span class="legend-dot" style="background:${s.schedColor};box-shadow:0 0 6px ${s.schedColor}"></span>
      ${s.schedName}
    </div>`).join('');

  // Build grid
  const shiftsByDay = {};
  allShifts.forEach(s => { if (!shiftsByDay[s.dayKey]) shiftsByDay[s.dayKey] = []; shiftsByDay[s.dayKey].push(s); });

  const todayKey = new Date().toISOString().slice(0, 10);
  const now = new Date();
  const sundayMs = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - now.getUTCDay());
  const DAY_NAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  let html = DAY_NAMES.map(d => `<div class="col-header">${d}</div>`).join('');

  for (let wi = 0; wi < WEEKS; wi++) {
    const wStart = new Date(sundayMs + wi * 7 * 86400000);
    const wEnd   = new Date(wStart.getTime() + 6 * 86400000);
    const fmt    = d => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    html += `<div class="week-label">
      <span>Week ${wi + 1}</span>
      <small>${fmt(wStart)} â€“ ${fmt(wEnd)}</small>
      <hr/>
    </div>`;

    for (let di = 0; di < 7; di++) {
      const dayMs  = sundayMs + (wi * 7 + di) * 86400000;
      const dayD   = new Date(dayMs);
      const dayKey = dayD.toISOString().slice(0, 10);
      const isToday = dayKey === todayKey;
      const dayShifts = shiftsByDay[dayKey] || [];
      const cls = isToday ? 'today' : dayShifts.length > 0 ? 'has-shifts' : 'empty';
      const numCls = isToday ? 'today-num' : dayShifts.length > 0 ? 'shift-num' : 'empty-num';

      const pills = dayShifts.map(s => `
        <div class="shift-pill">
          <div class="shift-bar" style="background:${s.schedColor}"></div>
          <div style="min-width:0">
            <div class="shift-sched" style="color:${s.schedColor}">${s.schedName}</div>
            <div class="shift-label">${s.label}</div>
            <div class="shift-time">${s.timeStr}</div>
          </div>
        </div>`).join('');

      html += `
        <div class="day-tile ${cls}">
          ${isToday ? '<div class="today-badge">TODAY</div>' : ''}
          <div class="day-num ${numCls}">${dayD.getUTCDate()}</div>
          ${pills}
        </div>`;
    }
  }

  document.getElementById('calendar').innerHTML = html;
}

function showError() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'flex';
}

async function init() {
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('error').style.display = 'none';
  document.getElementById('main').style.display = 'none';

  const spirit = getCookie('_spirit');
  const userId = parseInt(getCookie('user_id'), 10) || null;
  if (!spirit || !userId) { showError(); return; }

  // Get name from Connecteam API
  let myName = 'My Schedule';
  try {
    const r = await fetch('https://app.connecteam.com/api/UserDashboard/GetUserInfo/', { credentials: 'include' });
    const d = await r.json();
    const fn = d?.data?.firstName || '', ln = d?.data?.lastName || '';
    if (fn || ln) myName = `${fn} ${ln}`.trim();
  } catch {}

  const weeks = getWeekRanges();
  const [jobMaps, ...results] = await Promise.all([
    Promise.all(SCHEDULES.map(s => fetchJobMap(s))),
    ...SCHEDULES.flatMap((sched, si) =>
      weeks.map(week =>
        fetchShifts(sched, week, spirit)
          .then(shifts => ({ si, shifts }))
          .catch(() => ({ si, shifts: [] }))
      )
    ),
  ]);

  const allShifts = [];
  results.forEach(({ si, shifts }) => {
    shifts.forEach(s => {
      const formatted = formatShift(s, jobMaps[si], SCHEDULES[si].name, SCHEDULES[si].color, userId);
      if (formatted) allShifts.push(formatted);
    });
  });
  allShifts.sort((a, b) => a.sortKey - b.sortKey);
  render(myName, allShifts);
}

async function refresh() {
  document.getElementById('main').style.display = 'none';
  document.getElementById('loading').style.display = 'flex';
  await init();
}

init();
</script>
</body>
</html>
